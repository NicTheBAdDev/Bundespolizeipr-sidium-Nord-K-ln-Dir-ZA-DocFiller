<!DOCTYPE html>
<html lang="de" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <title>DocFiller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== THEME TOKENS ===== */
    :root{
      --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --ink:#111827; --muted:#6b7280;
      --btn-bg:#111827; --btn-fg:#ffffff; --focus:#3b82f6;
      /* Eingaben / Menüs */
      --input-bg:#ffffff; --input-fg:#111827;
      --menu-bg:#ffffff;  --menu-fg:#111827;
    }
    @media (prefers-color-scheme: dark){
      html[data-theme="auto"]{
        --bg:#0b1020; --card:#11162a; --border:#1f2640; --ink:#e5e7eb; --muted:#9aa4b2;
        --btn-bg:#2f3a68; --btn-fg:#ffffff; --focus:#60a5fa;
        --input-bg:#0f1530; --input-fg:#e5e7eb;
        --menu-bg:#0f1530;  --menu-fg:#e5e7eb;
      }
    }
    html[data-theme="dark"]{
      --bg:#0b1020; --card:#11162a; --border:#1f2640; --ink:#e5e7eb; --muted:#9aa4b2;
      --btn-bg:#2f3a68; --btn-fg:#ffffff; --focus:#60a5fa;
      --input-bg:#0f1530; --input-fg:#e5e7eb;
      --menu-bg:#0f1530;  --menu-fg:#e5e7eb;
    }
    html[data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb; --ink:#111827; --muted:#6b7280;
      --btn-bg:#111827; --btn-fg:#ffffff; --focus:#3b82f6;
      --input-bg:#ffffff; --input-fg:#111827;
      --menu-bg:#ffffff;  --menu-fg:#111827;
    }

    /* ===== BASE ===== */
    * { box-sizing: border-box; }
    html, body { margin:0; background:var(--bg); color:var(--ink);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    a { color: inherit; }
    .container { max-width: 880px; margin: 32px auto; padding: 0 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 4px 16px rgba(0,0,0,.06); padding:24px; position:relative; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .brand { font-weight:800; letter-spacing:.2px; }
    .theme-btn {
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px;
      border:1px solid var(--border); background:transparent; color:var(--ink); cursor:pointer;
    }
    .theme-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }
    h1 { margin:6px 0 16px; font-size:22px; }
    label { display:block; font-weight:600; margin:14px 0 6px; }
    input, select {
      width:100%; padding:10px 12px; border:1px solid var(--border);
      background:var(--input-bg); color:var(--input-fg);
      border-radius:10px; font-size:14px;
    }
    input::placeholder{ color:var(--muted); }
    /* Dropdown-Menüfarben (Browser-abhängig) */
    select option { background: var(--menu-bg); color: var(--menu-fg); }
    optgroup { color: var(--menu-fg); background: var(--menu-bg); font-style: normal; font-weight: 700; }
    input:focus, select:focus { outline: 2px solid var(--focus); outline-offset: 2px; }
    /* Autofill Fix (WebKit) */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
      -webkit-text-fill-color: var(--input-fg);
      -webkit-box-shadow: 0 0 0px 1000px var(--input-bg) inset;
      transition: background-color 9999s ease-out 0s;
    }

    button {
      margin-top:16px; padding:10px 14px; border-radius:10px; border:1px solid var(--btn-bg);
      background:var(--btn-bg); color:var(--btn-fg); font-weight:700; cursor:pointer;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .grid-two { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:720px){ .grid-two { grid-template-columns:1fr; } }
    .help { color:var(--muted); font-size:12px; margin-top:8px; }
    .error { color:#ef4444; white-space:pre-wrap; margin-top:12px; }
    .success { color:#10b981; margin-top:16px; }
    .links a { display:inline-block; margin-right:12px; text-decoration:underline; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid var(--border);
      border-top-color:var(--ink); border-radius:50%; animation:spin .9s linear infinite; vertical-align:middle; margin-left:8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .icon{ width:16px;height:16px; display:inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="brand">DocFiller</div>
        <button id="themeBtn" class="theme-btn" type="button" aria-label="Theme umschalten">
          <span id="themeIcon" class="icon" aria-hidden="true">🌙</span>
          <span id="themeLabel">Dark</span>
        </button>
      </header>

      <h1>Dokument erstellen</h1>

      <!-- Suchfeld -->
      <label for="search">Vorlagen suchen</label>
      <input id="search" type="search" placeholder="Tippe zum Filtern …" />

      <!-- Vorlagen-Auswahl -->
      <label for="template">Vorlage</label>
      <select id="template" required>
        <option value="" disabled selected>– Vorlage wählen –</option>
      </select>
      <div class="help">Feedback und Ideen und Bugs gehen bitte an [20] Nic Winter</div>
      <div class="help">Made by Nic Winter</div>

      <!-- Dynamisch generierte Felder -->
      <div id="dynamicFields"></div>

      <!-- Aktionen -->
      <button id="submitBtn" type="button">Dokument erzeugen</button>
      <div id="msg" class="help"></div>
      <div id="error" class="error" hidden></div>
      <div id="result" class="success"></div>
    </div>
  </div>

<script>
/* ========= KONFIG ========= */
const GAS_URL   = "https://script.google.com/macros/s/AKfycbz-Tuu-1R_T2cfM5jQlCz16PD3gP-OnD94nQ3OShEM1rSiRE5PYtZIEdK2wVtKBgneX/exec";
const API_TOKEN = ""; // optional, meist leer lassen

// Dropdown-Optionen je Placeholder (Option A)
const FIELD_OPTIONS = {
  "Beamtenverhältnis": ["auf Probe", "auf Widerruf", "auf Lebenszeit"],
  "Dienstgrad": [
    "Polizeimeisteranwärter",
    "Polizeimeister",
    "Polizeiobermeister",
    "Polizeihauptmeister",
    "Polizeikommissaranwärter",
    "Polizeikommissar",
    "Polizeioberkommissar",
    "Polizeihauptkommissar",
    "Polizeihauptkommissar A12",
    "Erster Polizeihauptkommissar"
],
  "Abteilung": ["DirZA1", "DirZA2", "DirZA3", "DirZA4", "DirZA5"],
  "Besoldungsgruppe": ["A6", "A7", "A8", "A9", "A10"],
  "Anrede": ["Frau", "Herr", "Divers"]
};

// EXPLIZITE Date-Picker Felder
const DATE_FIELDS = new Set(["Datum","Entlassungsdatum","Suspendierung bis zum","Datum der Suspendierung","Datum der Aufhebung","Ende der Probezeit"]);
function isDateField(key) { return DATE_FIELDS.has(key); }
/* ========================= */

/* ===== Dark Mode ===== */
(function initTheme(){
  const root = document.documentElement;
  const btn = document.getElementById('themeBtn');
  const icon = document.getElementById('themeIcon');
  const label = document.getElementById('themeLabel');

  const saved = localStorage.getItem('docf_theme'); // 'light' | 'dark' | 'auto'
  if (saved === 'light' || saved === 'dark' || saved === 'auto') {
    root.setAttribute('data-theme', saved);
  } else {
    root.setAttribute('data-theme', 'auto');
  }

  function currentMode(){ return root.getAttribute('data-theme') || 'auto'; }
  function updateUI(){
    const m = currentMode();
    if (m === 'dark') { icon.textContent = '☀️'; label.textContent = 'Light'; }
    else { icon.textContent = '🌙'; label.textContent = 'Dark'; }
  }
  updateUI();

  btn.addEventListener('click', () => {
    const m = currentMode();
    const next = m === 'dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', next);
    localStorage.setItem('docf_theme', next);
    updateUI();
  });
})();

/* ===== App Logic ===== */
const searchInput = document.getElementById('search');
const templateSelect = document.getElementById('template');
const dynamic = document.getElementById('dynamicFields');
const btn = document.getElementById('submitBtn');
const msg = document.getElementById('msg');
const err = document.getElementById('error');
const res = document.getElementById('result');

let ALL_TEMPLATES = [];

function showError(e){ err.hidden = false; err.textContent =
  (e && e.message) ? e.message : (typeof e === 'string' ? e : 'Unbekannter Fehler'); }
function clearStatus(){ err.hidden = true; err.textContent = '';
  res.innerHTML = ''; msg.textContent = ''; }

/* --- Required-field validation --- */
function validateRequiredFields() {
  let firstInvalid = null;
  dynamic.querySelectorAll('input, select').forEach(el => {
    if (!el.required) return;
    const isEmpty = (el.tagName === 'SELECT')
      ? (el.value === '')
      : (el.type === 'date' ? el.value === '' : el.value.trim() === '');
    if (isEmpty) {
      try { el.setCustomValidity('Bitte ausfüllen.'); } catch(e) {}
      if (!firstInvalid) firstInvalid = el;
    } else {
      try { el.setCustomValidity(''); } catch(e) {}
    }
  });
  if (firstInvalid) {
    try { firstInvalid.reportValidity(); } catch(e) {}
    try { firstInvalid.focus(); } catch(e) {}
    try { firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e) {}
    return false;
  }
  return true;
}

function updateSubmitState() {
  const hasTemplate = !!templateSelect.value;
  let allFilled = hasTemplate;
  dynamic.querySelectorAll('input[required], select[required]').forEach(el => {
    const empty = (el.tagName === 'SELECT') ? (el.value === '') :
                  (el.type === 'date' ? el.value === '' : el.value.trim() === '');
    if (empty) allFilled = false;
  });
  try { (document.getElementById('submitBtn')||{}).disabled = !allFilled; } catch(e) {}
}

// Hook up live validation
document.addEventListener('DOMContentLoaded', () => {
  if (typeof dynamic !== 'undefined') {
    dynamic.addEventListener('input', updateSubmitState);
    dynamic.addEventListener('change', updateSubmitState);
  }
  if (typeof templateSelect !== 'undefined') {
    templateSelect.addEventListener('change', updateSubmitState);
  }
  // Initial state
  try { updateSubmitState(); } catch(e) {}
});
/* --- end validation --- */

/* --- API helpers --- */
async function apiGet(params) {
  const url = new URL(GAS_URL);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  if (API_TOKEN) url.searchParams.set('token', API_TOKEN);
  const r = await fetch(url.toString(), { method: "GET", mode: "cors" });
  const j = await r.json();
  if (j.error) throw j.error;
  return j;
}
async function apiPost(action, payload) {
  const body = new URLSearchParams();
  body.set("action", action);
  if (API_TOKEN) body.set("token", API_TOKEN);
  body.set("payload", JSON.stringify(payload));
  const r = await fetch(GAS_URL, {
    method: "POST",
    mode: "cors",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body: body.toString()
  });
  const j = await r.json();
  if (j.error) throw j.error;
  return j;
}

/* --- Templates laden --- */
(async () => {
  try {
    msg.innerHTML = 'Lade Vorlagen<span class="spinner"></span>';
    const j = await apiGet({ action: "getTemplates" });
    ALL_TEMPLATES = j.templates || [];
    renderTemplateOptions(ALL_TEMPLATES);
    msg.textContent = ALL_TEMPLATES.length ? 'Vorlagen geladen.' : 'Keine Vorlagen gefunden.';
  } catch (e) { showError(e); }
})();

/* --- Select rendern --- */
function renderTemplateOptions(items) {
  templateSelect.innerHTML = '<option value="" disabled selected>– Vorlage wählen –</option>';
  items.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item.id;
    opt.textContent = item.name;
    templateSelect.appendChild(opt);
  });
}

/* --- Live-Suche --- */
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  const filtered = !q ? ALL_TEMPLATES : ALL_TEMPLATES.filter(t =>
    t.name.toLowerCase().includes(q)
  );
  renderTemplateOptions(filtered);
  dynamic.innerHTML = '';
  res.innerHTML = '';
  msg.textContent = filtered.length
    ? (q ? `Gefunden: ${filtered.length}` : '')
    : 'Keine Treffer.';
});

/* --- Vorlage geändert -> Platzhalter holen & Felder bauen --- */
templateSelect.addEventListener('change', async () => {
  clearStatus();
  dynamic.innerHTML = ''; res.innerHTML = '';
  const id = templateSelect.value;
  if (!id) return;

  try {
    msg.innerHTML = 'Lese Platzhalter<span class="spinner"></span>';
    const j = await apiGet({ action: "getPlaceholders", templateId: id });
    const keys = j.placeholders || [];

    const order = ['Vorname','Nachname','Datum','Entlassungsdatum'];
    keys.sort((a,b)=> (order.indexOf(a)+1 || 999) - (order.indexOf(b)+1 || 999) || a.localeCompare(b,'de'));

    keys.forEach(key => {
      const fieldId = 'f_' + key.replace(/\s+/g,'_');
      const label = document.createElement('label'); label.htmlFor = fieldId; label.textContent = key;

      let input;
      const opts = FIELD_OPTIONS[key];
      if (opts && Array.isArray(opts) && opts.length) {
        input = document.createElement('select');
        const empty = document.createElement('option');
        empty.value = ""; empty.textContent = "– bitte wählen –";
        input.appendChild(empty);
        opts.forEach(v => {
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          input.appendChild(o);
        });
      } else if (isDateField(key)) {
        input = document.createElement('input');
        input.type = 'date';
        input.valueAsDate = new Date();
      } else {
        input = document.createElement('input');
        input.type = 'text';
      }

      input.id = fieldId; input.dataset.key = key; input.required = true;

      if (/^(Vorname|Nachname)$/i.test(key)) {
        let row = dynamic.querySelector('.grid-two');
        if (!row) { row = document.createElement('div'); row.className = 'grid-two'; dynamic.appendChild(row); }
        const wrap = document.createElement('div'); wrap.appendChild(label); wrap.appendChild(input); row.appendChild(wrap);
      } else {
        dynamic.appendChild(label); dynamic.appendChild(input);
      }
    });

    msg.textContent = keys.length ? 'Platzhalter bereit.' : 'Keine {{…}}-Platzhalter in der Vorlage gefunden.';
  } catch (e) { showError(e); }
});

/* --- Generieren (Multi-Dokument kompatibel) --- */
btn.addEventListener('click', async () => {
  clearStatus();
  const templateId = templateSelect.value;
  if (!validateRequiredFields()) return;

  const fields = {};
  dynamic.querySelectorAll('input, select').forEach(inp => {
    const key = inp.dataset.key;
    const val = (inp.tagName === 'INPUT' && inp.type === 'date' && inp.value)
      ? new Date(inp.value).toLocaleDateString('de-DE')
      : inp.value;
    fields[key] = val ?? '';
  });

  btn.disabled = true;
  msg.innerHTML = 'Erzeuge Dokument<span class="spinner"></span>';

  try {
    const r = await apiPost('generateDoc', { templateId, fields });
    const items = (r && Array.isArray(r.results)) ? r.results : [r];

    res.innerHTML = `
      <p><strong>Fertig!</strong> Es wurden ${items.length} Dokument(e) erstellt:</p>
      ${items.map(it => `
        <div class="links" style="margin-bottom:8px">
          <em>${it.fileName}</em><br>
          <a href="${it.docUrl}" target="_blank" rel="noopener">Google&nbsp;Doc öffnen</a>
          <a href="${it.pdfUrl}" target="_blank" rel="noopener" style="margin-left:12px">PDF öffnen</a>
        </div>
      `).join('')}
    `;
    msg.textContent = 'Erzeugung abgeschlossen.';
  } catch (e) {
    showError(e);
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
